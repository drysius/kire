# Kire Engine Documentation for LLMs

## 1. Overview
Kire is a high-performance, asynchronous template engine for Node.js/TypeScript, inspired by Laravel Blade but built for the modern JavaScript ecosystem. It features a robust directive system, component architecture, custom element middleware, and first-class support for streaming and out-of-order rendering.

## 2. Core Concepts

### 2.1 Context Isolation
Kire is designed for high-concurrency environments.
- **Global Instance:** Holds shared configuration (directives, plugins, file cache).
- **`kire.fork()`:** Creates a lightweight copy for per-request isolation. **Always use `fork()` handling requests** to ensure local variables (`$props`) and request-specific globals (`$globals`) do not leak between users.

### 2.2 Streaming & Defer
Kire supports streaming responses to the client as they are generated.
- Enable with `stream: true` in options.
- **`@defer`**: Wraps slow-loading content. Kire will send placeholder HTML immediately, continue rendering the rest of the page, and then stream the deferred content script to inject it once ready (out-of-order flushing).

### 2.3 Namespaces
Namespaces map short prefixes to file system paths.
- **Standard:** `kire.namespace('~', './views/components')` maps `~/alert` to `./views/components/alert.kire`.
- **Root Wildcard:** `kire.namespace('@', './themes/{theme}')` acts as a fallback root.
  - If a path like `index` (no prefix) is requested, and no other namespace matches, it will resolve against the `@` namespace.
  - Example: `kire.view('index', { theme: 'dark' })` -> resolves to `./themes/dark/index.kire`.

## 3. Syntax & Data Binding

### 3.1 Interpolation
- **Standard:** `{{ variable }}` - Escapes HTML entities (XSS protection).
- **Raw:** `{{{ variable }}}` - Renders raw HTML.
- **Directives:** `@directive(args)` - Control flow.

### 3.2 Server-Side Logic
- **`@const(name = value)`**: Block-scoped constant.
- **`@let(name = value)`**: Block-scoped variable.
- **`<?js ... ?>`**: Raw JavaScript execution block (discouraged in favor of directives).

## 4. Directives Reference

### 4.1 Conditional
```kire
@if(user.role === 'admin')
  <button>Delete</button>
@elif(user.role === 'editor')
  <button>Edit</button>
@else
  <span>Read Only</span>
@end
```

### 4.2 Loops
Supports JavaScript `for` syntax and simplified pattern matching.
```kire
@for(user of users)
  <div>{{ user.name }}</div>
@empty
  <p>No users found.</p>
@end
```

### 4.3 Switch
```kire
@switch(status)
  @case('active') ... @end
  @case('pending') ... @end
  @default ... @end
@end
```

### 4.4 Components & Layouts
- **`@component('path', { props })`**: Renders a component.
  - **Aliases**: `@layout`, `@extends`.
- **`@slot('name')`**: Defines content for a named slot in the component.
  - **Alias**: `@section`.
- **`@yield('name', 'fallback')`**: (Inside component) Renders the slot content.
- **`@include('path', { props })`**: Simple partial include.

### 4.5 Sections & Stacks
- **`@define('name')`** / **`@defined('name')`**: Capture and render blocks of content.
- **`@push('stackName')`**: Push content (like scripts) to a stack.
- **`@stack('stackName')`**: Render all pushed content for that stack.

### 4.6 Web Helpers
- **`@csrf`**: Renders `<input type="hidden" name="_token" value="...">`.
- **`@method('PUT')`**: Renders `<input type="hidden" name="_method" value="PUT">`.
- **`@defer`**: Out-of-order streaming block.

## 5. Custom Elements (Middleware)
Map HTML tags to server-side functions.
```typescript
kire.element('my-component', async (ctx) => {
  // ctx.element.attributes
  // ctx.element.inner
  ctx.replaceElement(`<div>${ctx.element.inner}</div>`);
});
```

## 6. Runtime API (`$ctx`)
Available in all templates as `this` (if unbound) or `$ctx`.

- **`$props`**: Local template variables.
- **`$globals`**: Request-scoped globals.
- **`$add(str)`**: Write to output.
- **`$escape(str)`**: HTML escape.
- **`$resolve(path)`**: Resolve path aliases.
- **`$require(path, locals)`**: Render sub-template.
- **`$merge(fn)`**: buffer capture helper.

## 7. Kire Instance API
Methods available on the `kire` instance.

### Configuration & State
- **`fork()`**: Creates a lightweight, isolated copy of the instance for handling a request.
- **`namespace(name, path)`**: Registers a path namespace (supports `{var}` placeholders).
- **`plugin(plugin, opts)`**: Loads a plugin.
- **`$global(key, value)`**: Registers a global variable shared across ALL requests (read-only recommended).
- **`$prop(key, value)`**: Registers a default local prop (use carefully, prefer passing to render).
- **`cacheClear()`**: Clears compiled template cache.
- **`cached(namespace)`**: Retrieves a namespaced cache store.

### Extensibility
- **`directive(definition)`**: Registers a custom directive.
- **`element(name, handler)`**: Registers a custom HTML element handler.
- **`schematic(type, data)`**: Registers IDE support schematics.
- **`pkgSchema(name, repo, version)`**: Generates a JSON schema for the project configuration.

### Rendering
- **`view(path, locals)`**: Renders a template file.
- **`render(templateString, locals)`**: Renders a raw string.
- **`renderError(error, ctx)`**: Generates a styled HTML error page.
- **`compile(template)`**: Compiles template to JS source.
- **`compileFn(template)`**: Compiles template to an executable function.
- **`resolvePath(path, locals)`**: Resolves a path against registered namespaces.

## 8. Configuration Options
```typescript
const kire = new Kire({
  extension: 'kire',
  stream: false, // Enable for streaming support
  production: process.env.NODE_ENV === 'production',
  // Custom resolver (Required if not using default file system loaders)
  resolver: async (path) => fs.readFile(path, 'utf8')
});
```