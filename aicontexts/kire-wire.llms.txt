# KireWire (Wired) Comprehensive Documentation for LLMs

## 1. Introduction
KireWire (internally `Wired`) is a full-stack reactivity system for the Kire engine. It bridges the gap between the server (Node.js/TypeScript) and the client (Browser/Alpine.js) by synchronizing state transparently. It is heavily inspired by Laravel Livewire but built for the JS ecosystem.

## 2. Server-Side Architecture

### 2.1 The `WireComponent` Class
This is the base class for all standard components. It handles state management, lifecycle events, and rendering.

```typescript
import { WireComponent } from '@kirejs/wire';

export class Counter extends WireComponent {
    // PUBLIC PROPERTIES
    // These are synced with the client.
    // They must be JSON-serializable.
    public count = 0;
    public message = '';

    // LIFECYCLE HOOKS
    public async mount(initialCount = 0) {
        // Runs once on initialization (server-side only on first render)
        this.count = initialCount;
    }

    public async hydrated() {
        // Runs on every subsequent request, after state is restored from snapshot
    }

    public async updating(name: string, value: any) {
        // Runs before a property is updated
        if (name === 'count' && value > 10) {
            throw new Error('Count too high!');
        }
    }

    public async updated(name: string, value: any) {
        // Runs after a property is updated
    }

    // ACTIONS (Methods callable from client)
    public increment() {
        this.count++;
    }

    // RENDERING
    public render() {
        // Return inline HTML or use this.view('path/to/view')
        return `
            <div>
                <h1>{{ count }}</h1>
                <button wire:click="increment">+</button>
            </div>
        `;
    }
}
```

### 2.2 The `WirePageComponent`
A specialized component that includes pagination traits by default. Use this for full-page components or lists that require pagination.

```typescript
import { WirePageComponent } from '@kirejs/wire';

export class UsersTable extends WirePageComponent {
    public page = 1;      // Current page (synced automatically)
    public perPage = 10;  // Items per page

    public render() {
        // this.paginate(array) handles slicing based on this.page and this.perPage
        const users = await db.getUsers(); 
        const paginated = this.paginate(users);

        return this.view('users.table', { users: paginated });
    }
    
    // Available methods:
    // this.nextPage()
    // this.previousPage()
    // this.gotoPage(n)
    // this.resetPage()
}
```

### 2.3 Validation & Error Handling
KireWire includes a helper for validation.

```typescript
public save() {
    const isValid = this.validate({
        email: (val) => val.includes('@') || 'Invalid email',
        username: (val) => val.length > 3 || 'Username too short'
    });

    if (!isValid) return;

    // Proceed...
}
```

In the template, access errors via the `errors` object:
```html
<input wire:model="email">
@if(errors.email)
    <span class="error">{{ errors.email }}</span>
@end
```

## 3. Client-Side Directives (`wire:*`)
Directives control how the client interacts with the server component.

### 3.1 Actions (`wire:click`, `wire:submit`, etc.)
Trigger methods on the server.

- **`wire:click="method"`**: Trigger on click.
- **`wire:submit="method"`**: Trigger on form submit.
- **`wire:keydown.enter="method"`**: Trigger on Enter key.
- **`wire:mouseenter="method"`**: Trigger on hover.

**Modifiers:**
- `.prevent`: `e.preventDefault()`
- `.stop`: `e.stopPropagation()`
- `.debounce.Xms`: Debounce the call (e.g., `.debounce.500ms`).
- `.throttle.Xms`: Throttle the call.
- `.self`: Only trigger if event target is the element itself.

### 3.2 Data Binding (`wire:model`)
Syncs input values with server-side properties.

- **`wire:model="prop"`**: Syncs on `change` (lazy).
- **`wire:model.live="prop"`**: Syncs on `input` (real-time).
- **`wire:model.blur="prop"`**: Syncs on `blur`.
- **`wire:model.debounce.Xms="prop"`**: Debounce the sync request.

### 3.3 Loading States (`wire:loading`)
Visual feedback during network roundtrips.

- **`wire:loading`**: Show element when *any* request is pending.
- **`wire:loading.remove`**: Hide element when loading.
- **`wire:loading.class="opacity-50"`**: Add class when loading.
- **`wire:loading.attr="disabled"`**: Add attribute when loading.
- **`wire:target="method"`**: Only show when specific method/property is updating.
  - `wire:target="save"` -> Only shows when `save()` is called.
  - `wire:target="search"` -> Only shows when `search` property updates.

### 3.4 Polling (`wire:poll`)
Periodically refresh the component.

- **`wire:poll`**: Refresh every 2s (default).
- **`wire:poll.5s`**: Refresh every 5s.
- **`wire:poll.keep-alive`**: Keep polling even if tab is backgrounded.
- **`wire:poll.visible`**: Only poll when element is visible in viewport.

### 3.5 DOM Control
- **`wire:ignore`**: Tells KireWire (and Alpine) to **never** update the inner DOM of this element. Essential for 3rd-party libs (Maps, Charts, Select2).
- **`wire:ignore.self`**: Ignore only the element attributes, but allow children updates.
- **`wire:key="id"`**: Unique key for DOM diffing algorithm. **CRITICAL** inside `@for` loops to maintain state/focus.

### 3.6 Navigation (`wire:navigate`)
Enables SPA-like transitions without full page reloads.
- **`wire:navigate`**: On a link (`<a>`), fetches the next page via AJAX and swaps the body content.
- **`wire:navigate.hover`**: Prefetches the page on hover for instant navigation.

### 3.7 Streaming (`wire:stream`)
Allows the server to push partial HTML updates to specific DOM elements, bypassing full component re-render.

Server:
```typescript
this.stream('chat-log', '<div class="msg">Hello</div>', false, 'append');
```
Template:
```html
<div wire:stream="chat-log"></div>
```

### 3.8 Offline State (`wire:offline`)
Toggles visibility when the user loses internet connection.
- `wire:offline` (shows element)
- `wire:offline.class="bg-red-500"`
- `wire:offline.remove`

## 4. Initialization & Setup

To use KireWire in a view:

1. **Inject Scripts:**
   Ensure your layout includes the scripts directive.
   ```html
   <html>
   <head>
       @wired   <!-- Injects KireWire + Alpine.js -->
   </head>
   <body>
       ...
   </body>
   </html>
   ```

2. **Render a Component:**
   ```kire
   @wire('counter', { initialCount: 10 })
   ```

3. **Lazy Loading:**
   Render the component only when it is ready or visible.
   ```kire
   @wire('dashboard.stats', {}, { lazy: true, placeholder: 'Loading stats...' })
   ```
   This renders a placeholder first, then fetches the component content asynchronously.

## 5. Advanced Features

### 5.1 Entangle (Alpine.js Integration)
Share state between KireWire (server) and Alpine.js (client) seamlessly.

```html
<div x-data="{ open: $wire.entangle('showModal') }">
    <div x-show="open">...</div>
    <button @click="open = false">Close</button>
</div>
```
If `showModal` changes on the server, `open` updates in Alpine. If `open` updates in Alpine, it syncs back to the server.

### 5.2 Events & Listeners
**Server -> Client:**
```typescript
this.emit('post-created', { id: 1 });
```
Client:
```html
<div @post-created.window="console.log($event.detail)"></div>
```

**Client -> Server:**
Use `$wire.dispatch()` or plain DOM events if listeners are set up.

**Listeners property (Server):**
```typescript
public listeners = {
    'refresh-posts': '$refresh',
    'post-deleted': 'onPostDeleted'
};

public onPostDeleted(id) { ... }
```

## 6. Global Objects
- **`$wire` (Magic):** Available in Alpine expressions.
  - `$wire.get('prop')` / `$wire.prop`
  - `$wire.set('prop', value)`
  - `$wire.call('method', ...args)`
  - `$wire.$refresh()`
- **`window.Kirewire`:** Global API for manual interaction.
  - `Kirewire.find(componentId)`
  - `Kirewire.dispatch(event, params)`

## 7. Security (Checksums)
KireWire ensures state integrity using a `checksum`.
The snapshot sent to the client contains:
- `data`: The state.
- `memo`: Metadata (component name, id).
- `checksum`: `HMAC_SHA256(data + memo, secret + session_id)`.

If a user modifies the `data` in the browser devtools, the checksum validation will fail on the next request, and KireWire will reject the update with a `403 Forbidden`.

## 8. Common Pitfalls & Solutions
1. **Loop Issues:** Always use `wire:key` inside loops.
   ```kire
   @for(item of items)
       <div wire:key="item-{{ item.id }}">...</div>
   @end
   ```
2. **Root Element:** A KireWire component must have a **single root element**.
   ```html
   <!-- BAD -->
   <div>A</div>
   <div>B</div>

   <!-- GOOD -->
   <div>
       <div>A</div>
       <div>B</div>
   </div>
   ```
3. **DOM Diffing:** Do not manipulate the DOM of a KireWire component using external JS (jQuery, vanilla JS) unless you use `wire:ignore`, otherwise KireWire will overwrite changes on the next render.